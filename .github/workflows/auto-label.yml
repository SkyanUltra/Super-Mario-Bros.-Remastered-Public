name: Auto-Label Issues

on:
  issues:
    types: [opened]

permissions:
  issues: write  # Allows adding labels

jobs:
  label-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Extract type and apply label
        uses: actions/labeler@v5
        with:
          script: |
            const { issue } = github.event;
            const body = issue.body || '';
            
            // Map your form's choice values to labels (adjust based on your config.yml options)
            const typeToLabel = {
              'bug': 'type:bug',
              'feature': 'type:feature',
              'question': 'type:question',
              'documentation': 'type:docs',
              // Add more, e.g., 'support': 'type:support'
            };
            
            // Regex to match the selected choice in the issue body
            // Matches: "**Selected choice**\n<value>" (common GitHub form output)
            const match = body.match(/^\s*\*\*Selected choice\*\*\s*\n\s*(\w+)/im);
            if (match) {
              const selectedType = match[1].toLowerCase();
              const label = typeToLabel[selectedType];
              
              if (label) {
                // Get existing labels to avoid duplicates
                const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number
                });
                
                const hasLabel = labels.some(l => l.name === label);
                if (!hasLabel) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: [label]
                  });
                  console.log(`✅ Added label '${label}' to issue #${issue.number} (type: ${selectedType})`);
                } else {
                  console.log(`ℹ️ Label '${label}' already on issue #${issue.number}`);
                }
              } else {
                console.log(`⚠️ Unknown type '${selectedType}' in issue #${issue.number} - add to typeToLabel map`);
              }
            } else {
              console.log(`⚠️ No 'Selected choice' found in issue body #${issue.number} - check form template`);
            }
